
<!-- templates/polls/poll_results.html -->
{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <h2>{{ poll.question }} - Results</h2>
                <a href="{% url 'export_results' poll.id %}" class="btn btn-sm btn-outline-success">Export CSV</a>
            </div>
            <div class="card-body">
                <p><strong>Total Votes: {{ total_votes }}</strong></p>
                
                {% if choices_data %}
                    <!-- Numerical Results -->
                    <div class="mb-4">
                        <h4>Vote Count</h4>
                        {% for choice in choices_data %}
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>{{ choice.text }}</span>
                                    <span><strong>{{ choice.votes }} votes ({{ choice.percentage }}%)</strong></span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ choice.percentage }}%" 
                                         aria-valuenow="{{ choice.percentage }}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Charts -->
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Pie Chart</h4>
                            <canvas id="pieChart"></canvas>
                        </div>
                        <div class="col-md-6">
                            <h4>Bar Chart</h4>
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                {% else %}
                    <p>No votes yet for this poll.</p>
                {% endif %}
                
                <div class="mt-3">
                    <a href="{% url 'poll_list' %}" class="btn btn-secondary">Back to Polls</a>
                    {% if not poll.is_expired %}
                        <a href="{% url 'poll_detail' poll.id %}" class="btn btn-primary">Vote</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('{% url "poll_results_json" poll.id %}')
        .then(response => response.json())
        .then(data => {
            // Pie Chart
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: data.votes,
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Bar Chart
            const barCtx = document.getElementById('barChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Votes',
                        data: data.votes,
                        backgroundColor: '#36A2EB',
                        borderColor: '#36A2EB',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        });
});
</script>
{% endblock %}